<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow State Timer</title>
    <!-- PWA MANIFEST LINK (Required for installation) -->
    <link rel="manifest" href="manifest.json">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #ffffff;
            /* Flex layout helps center content vertically and horizontally */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            /* IMPORTANT: Ensure no margin/padding is inherited on the body that causes scrolling */
            margin: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        /* Custom styling for the timer display */
        .timer-text {
            /* Adjusted clamp: smaller minimum size (2.5rem) and tighter viewport scale (12vw) */
            font-size: clamp(2.5rem, 12vw, 10rem); 
            font-weight: 800;
            transition: color 0.3s ease;
            /* Ensure the text itself is tight and doesn't create extra space */
            line-height: 1.1; 
        }
        .time-input {
            width: 100%;
            text-align: center;
            appearance: textfield;
            -moz-appearance: textfield;
            border: 2px solid transparent;
            background-color: #161b22;
        }
        .time-input:focus {
            border-color: #38bdf8;
            outline: none;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.5);
        }
    </style>
    <!-- Load Tone.js for customizable audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
</head>
<body>

    <!-- UPDATED: Changed max-w-xl to max-w-md for better mobile fit -->
    <div id="app" class="w-full max-w-md bg-[#161b22] p-4 sm:p-6 rounded-2xl shadow-2xl border border-gray-700">
        <h1 class="text-3xl font-bold text-center mb-5 text-fuchsia-400">Flow State Timer</h1>

        <!-- Settings Section -->
        <div id="settings" class="space-y-4 mb-6">
            <h2 class="text-xl font-semibold mb-3 text-gray-300">Session Setup (Minutes)</h2>

            <div class="grid grid-cols-2 gap-4">
                <!-- Flow Time Input -->
                <div>
                    <label for="flowTime" class="block text-sm font-medium text-gray-400">Flow Time (Minutes)</label>
                    <input type="number" id="flowTime" value="25" min="1" max="180" class="time-input mt-1 p-2 rounded-lg text-lg text-white">
                </div>

                <!-- Short Break Time Input -->
                <div>
                    <label for="breakTime" class="block text-sm font-medium text-gray-400">Short Break Time (Minutes)</label>
                    <input type="number" id="breakTime" value="5" step="1" min="1" max="30" class="time-input mt-1 p-2 rounded-lg text-lg text-white">
                </div>
            </div>

            <h2 class="text-xl font-semibold pt-4 mb-3 text-gray-300">Sound Customization</h2>
            <p class="text-sm text-gray-500">Customize the sound frequency (Hz) for each phase change.</p>

            <div class="grid grid-cols-3 gap-4">
                <div class="text-center">
                    <label for="flowFreq" class="block text-sm font-medium text-gray-400">Flow Start (Hz)</label>
                    <input type="number" id="flowFreq" value="600" min="100" max="1000" class="time-input mt-1 p-2 rounded-lg text-lg text-white">
                </div>
                <div class="text-center">
                    <label for="breakFreq" class="block text-sm font-medium text-gray-400">Break Start (Hz)</label>
                    <input type="number" id="breakFreq" value="400" min="100" max="1000" class="time-input mt-1 p-2 rounded-lg text-lg text-white">
                </div>
                <div class="text-center">
                    <label for="endFreq" class="block text-sm font-medium text-gray-400">Final Countdown (Hz)</label>
                    <input type="number" id="endFreq" value="800" min="100" max="1000" class="time-input mt-1 p-2 rounded-lg text-lg text-white">
                </div>
            </div>
        </div>

        <!-- Timer Display (Padding reduced from p-8 to p-6) -->
        <div id="timerDisplay" class="text-center bg-[#0d1117] p-6 rounded-xl shadow-inner border border-gray-700">
            <div id="phaseText" class="text-2xl font-semibold mb-2 h-8 text-gray-400">Ready</div>
            <div class="text-lg font-medium text-fuchsia-500 mb-4 h-6 invisible">.</div> 
            <div id="countdown" class="timer-text text-white">00:00</div>
        </div>

        <!-- Controls -->
        <div class="flex justify-center space-x-4 mt-6">
            <button id="startButton" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md transition duration-200 disabled:opacity-50">
                Start
            </button>
            <button id="pauseButton" class="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg shadow-md transition duration-200" disabled>
                Pause
            </button>
            <button id="resetButton" class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition duration-200">
                Reset
            </button>
        </div>
        
        <!-- Message Box -->
        <div id="messageBox" class="mt-4 p-3 text-center text-sm rounded-lg bg-red-900/50 text-red-300 hidden" role="alert"></div>

    </div>

    <script>
        // *** Service Worker Registration for PWA functionality ***
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Register the service worker relative to the root of the site
                navigator.serviceWorker.register('/service-worker.js') 
                    .then(registration => {
                        // console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        // console.error('Service Worker registration failed:', error);
                    });
            });
        }
        
        // --- CONSTANTS AND STATE ---
        const $ = (id) => document.getElementById(id);

        const flowTimeInput = $('flowTime');
        const breakTimeInput = $('breakTime');
        const startButton = $('startButton');
        const pauseButton = $('pauseButton');
        const resetButton = $('resetButton');
        const countdownDisplay = $('countdown');
        const phaseText = $('phaseText');
        const timerDisplay = $('timerDisplay');
        const messageBox = $('messageBox');

        let intervalId = null;
        let isPaused = false;
        let isRunning = false;
        let currentTime = 0;
        let currentPhase = 'FLOW'; // Possible: 'FLOW', 'BREAK', 'PREP'

        // --- TONE.JS AUDIO SETUP ---
        let synth;

        function initializeAudio() {
            if (Tone.context.state !== 'running') {
                Tone.start();
            }
            synth = new Tone.FMSynth().toDestination();
        }

        // Plays a customizable tone
        function playTone(frequencyId, duration = 0.5) {
            if (!synth) return;
            const freq = parseFloat($(frequencyId).value);
            synth.triggerAttackAttackRelease(freq, duration);
        }

        // Plays the final end sound (triple high-pitched beep)
        function playEndTone() {
            if (!synth) return;
            const freq = parseFloat($('endFreq').value);
            const now = Tone.now();
            synth.triggerAttackAttackRelease(freq, "8n", now);
            synth.triggerAttackAttackRelease(freq, "8n", now + 0.4);
            synth.triggerAttackAttackRelease(freq * 1.5, "8n", now + 0.8); // Higher pitch for final
        }


        // --- UI UTILITIES ---

        function formatTime(seconds) {
            const totalSeconds = Math.round(seconds);
            const min = Math.floor(totalSeconds / 60);
            const sec = totalSeconds % 60;
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            countdownDisplay.textContent = formatTime(currentTime);

            // Update color and text based on phase
            if (currentPhase === 'FLOW') {
                timerDisplay.style.color = '#e879f9'; // Tailwind fuchsia-400
                phaseText.textContent = 'FLOW TIME';
                phaseText.className = 'text-2xl font-semibold mb-2 h-8 text-fuchsia-400';
            } else if (currentPhase === 'BREAK') {
                timerDisplay.style.color = '#38bdf8'; // Tailwind sky-400
                phaseText.textContent = 'SHORT BREAK';
                phaseText.className = 'text-2xl font-semibold mb-2 h-8 text-sky-400';
            } else {
                 // PREP
                timerDisplay.style.color = '#10b981'; // Tailwind emerald-400
            }

            if (currentTime <= 3 && currentTime > 0 && isRunning) {
                countdownDisplay.classList.add('text-red-500');
            } else {
                countdownDisplay.classList.remove('text-red-500');
            }
        }

        function toggleInputs(disabled) {
            flowTimeInput.disabled = disabled;
            breakTimeInput.disabled = disabled;
        }

        function showMessage(msg, isError = false) {
            messageBox.textContent = msg;
            messageBox.className = `mt-4 p-3 text-center text-sm rounded-lg ${isError ? 'bg-red-900/50 text-red-300' : 'bg-fuchsia-900/50 text-fuchsia-300'}`;
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, 5000);
        }


        // --- TIMER LOGIC ---

        function setPhase(phase) {
            currentPhase = phase;
            
            // Convert input minutes (float) to seconds
            const flowInSeconds = parseFloat(flowTimeInput.value) * 60;
            const breakInSeconds = parseFloat(breakTimeInput.value) * 60;

            if (currentPhase === 'FLOW') {
                currentTime = flowInSeconds;
                playTone('flowFreq', 0.8);
            } else if (currentPhase === 'BREAK') {
                currentTime = breakInSeconds;
                playTone('breakFreq', 0.8);
            } else if (currentPhase === 'PREP') {
                 currentTime = 10;
                 phaseText.textContent = 'GET READY';
                 phaseText.className = 'text-2xl font-semibold mb-2 h-8 text-emerald-400';
                 playTone('endFreq', 1.0); // Use a distinct tone for start alert
            }
            updateDisplay();
        }

        function nextPhase() {
            if (currentPhase === 'PREP') {
                // PREP -> FLOW (Initial transition)
                setPhase('FLOW');
            } else if (currentPhase === 'FLOW') {
                // FLOW -> BREAK
                setPhase('BREAK');
            } else if (currentPhase === 'BREAK') {
                // BREAK -> FLOW (Continuous loop)
                setPhase('FLOW');
            }
        }

        function tick() {
            if (isPaused) return;

            if (currentTime <= 0) {
                nextPhase();
            } else {
                currentTime--;
                
                // Audio cue for last 3 seconds
                if (currentTime <= 3 && currentTime > 0) {
                    playTone('endFreq', 0.1); 
                }

                updateDisplay();
            }
        }
        
        // --- CONTROL FUNCTIONS ---

        function startTimer() {
            const flowValue = parseFloat(flowTimeInput.value);
            const breakValue = parseFloat(breakTimeInput.value);

            if (flowValue <= 0 || breakValue <= 0) {
                showMessage("Please ensure Flow Time and Break Time are greater than zero.", true);
                return;
            }
            
            initializeAudio();

            if (!isRunning) {
                isRunning = true;
                toggleInputs(true);
                setPhase('PREP');
                intervalId = setInterval(tick, 1000);
            } else if (isPaused) {
                isPaused = false;
                showMessage("Timer resumed.", false);
            }

            startButton.disabled = true;
            pauseButton.disabled = false;
        }

        function pauseTimer() {
            if (!isRunning) return;
            isPaused = true;
            startButton.disabled = false;
            pauseButton.disabled = true;
            phaseText.textContent = 'PAUSED';
            phaseText.className = 'text-2xl font-semibold mb-2 h-8 text-red-400';
            showMessage("Timer paused.", false);
        }

        function resetTimer() {
            clearInterval(intervalId);
            intervalId = null;
            isRunning = false;
            isPaused = false;
            
            const initialFlowTimeSeconds = parseFloat(flowTimeInput.value) * 60 || 1500;
            
            currentPhase = 'FLOW';
            currentTime = initialFlowTimeSeconds; 
            
            toggleInputs(false);
            startButton.disabled = false;
            pauseButton.disabled = true;
            
            phaseText.textContent = 'Ready';
            phaseText.className = 'text-2xl font-semibold mb-2 h-8 text-gray-400';
            countdownDisplay.textContent = formatTime(currentTime);
            
            showMessage("Timer reset.", false);
        }


        // --- EVENT LISTENERS ---

        startButton.addEventListener('click', startTimer);
        pauseButton.addEventListener('click', pauseTimer);
        resetButton.addEventListener('click', resetTimer);

        // Initialize display on load
        window.onload = resetTimer; 

    </script>
</body>
</html>
